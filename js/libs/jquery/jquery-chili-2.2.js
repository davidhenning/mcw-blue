/*!
 * Chili - the jQuery plugin for highlighting code
 * http://noteslog.com/chili/
 * 
 * Copyright 2010 Andrea Ercolino
 * Dual licensed under the MIT and GPL licenses.
 * http://docs.jquery.com/License
 * 
 * VERSION: NEXT - 20120316 2358
 */(function($){function getRecipePath(a){var b=$.chili.options.dynamic.origin+"jquery.chili.recipes."+a+".js";return b}function getRecipeName(a){var b=a.match(/\bjquery\.chili\.recipes\.([\w-]+)\.js$/i),c=b[1];return c}function askDish(a){var b=$.chili.codeLanguage(a);if(""==b)return;var c=getRecipePath(b);$.chili.options.dynamic.active&&!$.chili.recipes[b]?($.chili.queue[c]||downloadRecipe(c,makeDish,[c]),$.chili.queue[c].push(a)):($(a).trigger("chili.before_coloring",[b]),makeDish.apply(a,[c]),$(a).trigger("chili.after_coloring",[b]))}function makeDish(a){var b=getRecipeName(a),c=$.chili.recipes[b];if(!c)return;var d=$(this).text();if(!d)return;d=fixWhiteSpaceAfterReading(d),replaceElement.apply({selector:this,subject:d,module:b,context:{}}),fixTextSelection(this),checkLineNumbers(this)}function replaceElement(){filtersPrepare(this);var a=applyModule(this.subject,this.module,this.context);a=filtersProcess(this,a),a=fixWhiteSpaceBeforeWriting(a);var b=$(this.selector)[0];b.innerHTML=a}function requestedAction(a,b,c){return""!=c?"applyStep":""!=b?"applyBlock":""!=a?"applyRecipe":""}function detectAction(a,b){if(!a)return;var c=new RegExp("^(?!(?:/$|.+/$|.+//$|.+//.))([^/]*)(?:/([^/]*)(?:/([^/]+))?)?$"),d=(a||"").match(c);if(!d)return;var e=d[1]||"",f=d[2]||"",g=d[3]||"",h=requestedAction(e,f,g),i=getRecipe(e,b),j={action:h,recipeName:e,blockName:f,stepName:g,recipe:i,module:a,context:b};return j}function getRecipe(a,b){var c=null;return""==a?c=b.recipe:c=$.chili.recipes[a],c}function downloadRecipe(a,b,c){$.chili.queue[a]=[],$.getScript(a,function(d){var e=getRecipeName(a),f=$.chili.queue[a];for(var g=0,h=f.length;g<h;g++){var i=f[g];"undefined"!=typeof i.selector&&(i=$(i.selector)[0]),$(i).trigger("chili.before_coloring",[e]),b.apply(f[g],c),$(i).trigger("chili.after_coloring",[e])}})}function applyRecipe(a,b){var c=b.recipe;return result=cook(a,c),result}function applyBlock(a,b){var c=b.blockName,d=b.recipe;return c in d?result=cook(a,d,c):result=escapeHtmlSpecialChars(a),result}function applyStep(a,b){var c=b.recipeName,d=b.blockName,e=b.stepName,f=b.recipe,g=b.context;return""==d&&(d=g.blockName),d in f&&e in f[d]?result=cook(a,f,d,e):result=escapeHtmlSpecialChars(a),result}function applyAction(a,b){var c="",d=b.action;switch(d){case"applyRecipe":c=applyRecipe(a,b);break;case"applyBlock":c=applyBlock(a,b);break;case"applyStep":c=applyStep(a,b);break;default:}return c}function applyDeferred(a,b){var c=getRecipePath(b.recipeName);$.chili.queue[c]||downloadRecipe(c,replaceElement);var d="chili_"+unique();return $.chili.queue[c].push({selector:"#"+d,subject:a,module:b.module,context:b.context}),result='<span id="'+d+'">'+result+"</span>",result}function applyModule(a,b,c){var d="",e=detectAction(b,c);return typeof e=="undefined"?d=escapeHtmlSpecialChars(a):e.recipe?d=applyAction(a,e):$.chili.options.dynamic.active?d=applyDeferred(a,e):d=escapeHtmlSpecialChars(a),d}function unique(a){var b=(new Date).valueOf();while(a&&a.indexOf(b)>-1);return b=(new Date).valueOf(),b}function prepareBlock(a,b){var c=[],d=a[b];for(var e in d){var f=prepareStep(a,b,e);c.push(f)}return c}function numberOfSubmatches(a){var b=a.replace(/\\./g,"%").replace(/\[.*?\]/g,"%").match(/\((?!\?)/g),c=(b||[]).length;return c}function prepareStep(a,b,c){var d=a[b][c],e=typeof d._match=="string"?d._match:d._match.source,f=d._replace?d._replace:'<span class="$0">$$</span>',g={recipe:a,blockName:b,stepName:c,exp:"("+e+")",length:numberOfSubmatches(e)+1,replacement:f};return g}function adjustBackReferences(a){var b=1,c=[];for(var d=0,e=a.length;d<e;d++){var f=a[d].exp;f=f.replace(/\\\\|\\(\d+)/g,function(a,c){return c?"\\"+(b+1+parseInt(c,10)):a}),c.push(f),b+=a[d].length}return c}function knowHow(a,b){var c="((?:\\s|\\S)*?)",d="((?:\\s|\\S)+)",e=adjustBackReferences(a),f="(?:"+e.join("|")+")";return f=c+f+"|"+d,new RegExp(f,b)}function addPrefix(a,b){var c=/(<span\s+class\s*=\s*(["']))((?:(?!__)\w)+\2\s*>)/ig,d="$1"+a+"__$3",e=b.replace(c,d);return e}function locateStepMatches(a,b){var c=2;for(var d=0,e=a.length;d<e;d++){var f=a[d],g=b[c];if(g)break;c+=f.length}var h=b.slice(c,c+f.length);return h.push(b.index),h.push(b.input),{step:f,matches:h}}function functionReplacement(a){var b={x:function(b,c){var d=applyModule(b,c,a.step);return d}},c=a.step.replacement.apply(b,a.matches);return c}function templateReplacement(a){var b=/(\\\$)|(?:\$\$)|(?:\$(\d+))/g,c=function(b,c,d){var e="";return c?e="$":d?d=="0"?e=a.step.stepName:e=escapeHtmlSpecialChars(a.matches[d]):e=escapeHtmlSpecialChars(a.matches[0]),e},d=a.step.replacement.replace(b,c);return d}function chef(a,b){var c="",d=b[0];if(!d)return c;var e=b[b.length-1];if(e)return c=escapeHtmlSpecialChars(e),c;var f=locateStepMatches(a,b);c=$.isFunction(f.step.replacement)?functionReplacement(f):templateReplacement(f);var g=b[1];return g=escapeHtmlSpecialChars(g),c=addPrefix(f.step.recipe._name,c),c=g+c,c}function applySteps(a,b,c){var d=b._case?"g":"gi",e=knowHow(c,d),f=[],g;while((g=e.exec(a))!=null&&g[0]!=""){var h=chef(c,g);f.push(h)}return f=f.join(""),f}function cook(a,b,c,d){if(d)var e=prepareStep(b,c,d),f=[e];else{c||(c="_main",checkSpices(b));if(!c in b)return escapeHtmlSpecialChars(a);var f=prepareBlock(b,c)}var g=applySteps(a,b,f);return g}function cssClassDefinition(a,b){var c="."+a+"\n"+"{\n"+"\t"+b+"\n"+"}\n";return c}function makeStylesheet(a){var b=a._name,c=["/* Chili -- "+b+" */"];for(var d in a){if(d.search(/^_(?!main\b)/)>=0)continue;var e=a[d];for(var f in e){var g=e[f];if(!1 in g)continue;var h=g._style;if(typeof h=="string"){var i={};i[f]=h,h=i}for(var j in h){var k=b+"__"+j,l=h[j],m=cssClassDefinition(k,l);c.push(m)}}}var n=c.join("\n");return n}function checkSpices(a){var b=a._name;if(!$.chili.queue[b]){var c=makeStylesheet(a);$.chili.loadStylesheetInline(c),$.chili.queue[b]=!0}}function repeat(a,b){var c="";for(var d=0;d<b;d++)c+=a;return c}function escapeHtmlSpecialChars(a){var b=a.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;");return b}function unescapeHtmlSpecialChars(a){var b=a.replace(/&amp;/g,"&").replace(/&lt;/g,"<").replace(/&gt;/g,">");return b}function scan(a,b,c){c=c||[];var d=/([\w\W]*?)(?:(<\w+[^>]*\/>)|(<\w+[^>]*>)|(<\/\w+[^>]*>))|([\w\W]+)/ig,e=function(a,d,e,g,h,i){var j=f.index,k;i?(k=tokenMake("text",i,j),b.apply(k,c)):(k=tokenMake("text",d,j),b.apply(k,c),j+=d.length,e?k=tokenMake("empty",e,j):g?k=tokenMake("open",g,j):h&&(k=tokenMake("close",h,j)),b.apply(k,c))},f;while((f=d.exec(a))!=null&&f[0]!="")e.apply({},f)}function escapeSpaces(a){var b=$.chili.options.whiteSpace.writingSpace,c=a.replace(/ /g,b);return c}function escapeTabs(a){var b=$.chili.options.whiteSpace.writingTab,c=a.replace(/\t/g,b);return c}function lineFeedsToNewLines(a){var b=$.chili.options.whiteSpace.writingNewLine,c=a.replace(/\n/g,b);return c}function newLinesToLineFeeds(a){var b=a;return b=b.replace(/&nbsp;<BR>/ig,"\n"),b=b.replace(/\r\n?/g,"\n"),b}function setWhiteSpaceConstants(a){$.chili.options.whiteSpace.writingSpace="&#160;",$.chili.options.whiteSpace.writingTab=repeat("&#160;",$.chili.options.whiteSpace.tabWidth),$.chili.options.whiteSpace.writingNewLine="\n",/\r\n?/.test(a)&&($.browser.msie?$.chili.options.whiteSpace.writingNewLine="&#160;<br>":$.chili.options.whiteSpace.writingNewLine=/\r\n/.test(a)?"\r\n":"\r")}function fixWhiteSpaceAfterReading(a){setWhiteSpaceConstants(a);var b=newLinesToLineFeeds(a);return $.chili.options.whiteSpace.no1stLine&&(b=b.replace(/^\n/,"")),b}function fixWhiteSpaceBeforeWriting(a){var b=[];return scan(a,function(){var a=this.value;this.type=="text"&&(a=escapeSpaces(a),a=escapeTabs(a),a=lineFeedsToNewLines(a)),b.push(a)}),b=b.join(""),b}function well_form(a,b){var c=[],d=b.join("");scan(a,function(){this.type=="open"?b.push(this.value):this.type=="close"&&b.pop()});for(var e=0,f=b.length;e<f;e++){var g=b[e],h=g.replace(/^<(\w+)[^>]*>$/,"</$1>");c.unshift(h)}var i=c.join("");return a=d+a+i,{line:a,open:b}}function makeOrderedList(a){var b=[],c=/(.*)\n/g,d=function(a,c){var d=well_form(c,b);return b=d.open,c=d.line?"<li>"+d.line+"</li>":"<li> </li>",c},e=a.replace(c,d);return e="<ol>"+e+"</ol>",e}function setLineNumbersStart(a,b,c){var d=parseInt(b,10);if(c){var e=$("."+a),f=e.index(this);e.slice(0,f).each(function(){d+=$(this).find("li").length})}$(this).find("ol").attr("start",d),$("body").width($("body").width()-1).width($("body").width()+1)}function addLineNumbers(a){var b=$(a).html();b=fixWhiteSpaceAfterReading(b),b=makeOrderedList(b),b=fixWhiteSpaceBeforeWriting(b),a.innerHTML=b}function checkLineNumbers(a){var b=$.chili.codeLineNumbers(a);b?(addLineNumbers(a),setLineNumbersStart.apply(a,b)):$.chili.options.decoration.lineNumbers&&addLineNumbers(a)}function filtersPrepare(that){var subject=that.subject;if(!/{:\w+\(/.test(subject))return;var format=0,expr=/({:(\w+)\((|(?:(['"])[^\4\n]*(?:\\.[^\4\n]*)*\4)(?:\s*,\s*((['"])[^\6\n]*(?:\\.[^\6\n]*)*\6))*)\)\[)((?:.|\n)*?)(\]\2:})/g,func=function(all,tag_open,callback,args,ignore4,ignore5,ignore6,target,tag_close,offset){eval("args = ["+args+"];");var filter={original:target,start:offset-format,count:target.length,callback:callback,args:args};return format+=tag_open.length+tag_close.length,$.isArray(that.filters)?that.filters.push(filter):that.filters=[filter],target};subject=escapeHtmlSpecialChars(subject),subject=subject.replace(expr,func),subject=unescapeHtmlSpecialChars(subject),that.subject=subject}function tokenMake(a,b,c){var d={type:a,value:b,start:c};return d}function tokenSplit(a){var b=[],c=0;return scan(a,function(){switch(this.type){case"empty":case"open":case"close":c+=this.value.length;break;case"text":this.start-=c,this.end=this.start+this.value.length;break;default:throw"no type case for '"+this.type+"'"}b.push(this)}),b}function stripEmpties(a){var b=a.replace(/<span[^>]+><\/span>/g,"");return b}function tokenJoin(a){var b=[];for(var c=0,d=a.length;c<d;c++)b.push(a[c].value);return b=b.join(""),b=stripEmpties(b),b}function tokenFind(a,b,c){var d=b+c,e=-1,f=-1,g="",h="",i="";for(var j=0,k=a.length;j<k;j++){var l=a[j];if(l.type=="open")g=l.value;else if(l.type=="close")g="";else{l.start<=b&&b<l.end&&(e=j,h=g),l.start<=d&&d<l.end&&(f=j,i=g);if(e!=-1&&f!=-1)break}}var m={first:{position:e,span:h},last:{position:f,span:i}};return m}function tokenBreak(a,b,c){var d=a.value.substr(0,b),e=tokenMake("text",d,a.start);e.end=a.start+d.length;var f=a.value.substr(b),g=tokenMake("text",f,a.start+b);g.end=a.start+b+f.length;var h={first:[e],second:[g]};return c&&(h.first.push(tokenMake("close","</span>")),h.second.unshift(tokenMake("open",c))),h}function tokenExtract(a,b,c){var d=b+c,e=tokenFind(a,b,c),f=a.slice(0,e.first.position),g=a[e.first.position],h=a.slice(e.first.position+1,e.last.position),i=a[e.last.position],j=a.slice(e.last.position+1),k=tokenBreak(g,b-g.start,e.first.span),l=tokenBreak(i,d-i.start,e.last.span),m=[].concat(k.second,h,l.first);m=tokenJoin(m);var n=tokenMake("html",m,b);a=[].concat(f,k.first,n,l.second,j);var o={tokens:a,position:f.length+k.first.length};return o}function filtersProcess(a,b){var c=b;if(!a.filters)return c;var d=[];for(var e=0,f=a.filters.length;e<f;e++){var g=a.filters[e],h=$.chili.filters&&$.chili.filters[g.callback];if(!h||!$.isFunction(h))continue;0==d.length&&(d=tokenSplit(b));var i=tokenExtract(d,g.start,g.count);d=i.tokens;var j=i.position,k={text:g.original,html:d[j].value},l=g.args,m=h.apply(k,l);d[j].value=m}return 0<d.length&&(c=tokenJoin(d)),c}function clearPreviousSelection(){$.browser.msie?document.selection.empty():window.getSelection().removeAllRanges()}function resetSelectedTextElement(){element=this,clearPreviousSelection()}function getSelectedText(){var a;if($.browser.msie)a=document.selection.createRange().htmlText;else{var b=window.getSelection(),c=b.getRangeAt(0);b=b.toString(),c=c.toString(),a=/\n/.test(b)?b:c}return a}function preserveNewLines(a){var b=unique(a),c="";if(/<br\b/i.test(a)||/<li\b/i.test(a)){/<br\b/i.test(a)?a=a.replace(/\<br[^>]*?\>/ig,b):/<li\b/i.test(a)&&(a=a.replace(/<ol[^>]*?>|<\/ol>|<li[^>]*?>/ig,"").replace(/<\/li>/ig,b));var d=$("<pre>").appendTo("body").hide()[0];d.innerHTML=a,c=$(d).text().replace(new RegExp(b,"g"),"\r\n"),$(d).remove()}return c}function cleanText(a){var b=$.browser.msie?preserveNewLines(a):a.replace(/\r/g,"").replace(/^# ?/g,"").replace(/\n# ?/g,"\n");return b}function makeDialog(a,b){var c=$.chili.options.selection.box,d=$.browser.msie?'<textarea style="'+c.style+'">':'<pre style="'+c.style+'">',e=$(d).appendTo("body").text(a).attr("id","chili_selection").click(function(){$(this).remove()}),f=c.top(b.pageX,b.pageY,e.width(),e.height()),g=c.left(b.pageX,b.pageY,e.width(),e.height());return e.css({top:f,left:g}),e}function selectTextAgain(a){if($.browser.msie)a[0].focus(),a[0].select();else{var b=window.getSelection();b.removeAllRanges();var c=document.createRange();c.selectNodeContents(a[0]),b.addRange(c)}}function displaySelectedTextDialog(a){if(!element||element!=this)return;element=null;var b=getSelectedText();if(""==b)return;b=cleanText(b);var c=makeDialog(b,a);selectTextAgain(c)}function fixTextSelection(a){if($.chili.options.selection.active&&($.browser.msie||$.browser.mozilla)){var b=null;$(a).parents().filter("pre").bind("mousedown",resetSelectedTextElement).bind("mouseup",displaySelectedTextDialog)}}$.extend({chili:{options:{whiteSpace:{tabWidth:4,no1stLine:!1},automatic:{active:!0,selector:"code",context:document},dynamic:{active:!0,origin:""},decoration:{lineNumbers:!0},selection:{active:!0,box:{style:["position:absolute; z-index:3000; overflow:scroll;","width:16em;","height:9em;","border:1px solid gray;","padding:1em;","background-color:white;"].join(" "),top:function(a,b,c,d){var e=b-Math.round(d/2);return e},left:function(a,b,c,d){var e=a;return e}}}}}}),$(function(){$.chili.loadStylesheetInline(".chili-ln-off {list-style-type: none;}"),$.extend($.chili,$.chili.options),$.chili.automatic.active&&$($.chili.automatic.selector,$.chili.automatic.context).chili()}),$.extend($.chili,{version:"next",codeLanguage:function(a){return $(a).attr("class")||""},codeLineNumbers:function(a){var b=$(a).attr("class"),c=b.match(/\bchili-ln-(\d+)-([\w][\w\-]*)|\bchili-ln-(\d+)/),d=c?c[3]?[c[0],c[3],""]:[c[0],c[1],c[2]]:null;return d},revealChars:function(a){var b=[];for(var c=0,d=a.length;c<d;c++)b.push(a[c]+" <- "+a.charCodeAt(c));return b=b.join("\n"),b},loadStylesheetInline:function(a){if(document.createElement){var b=document.createElement("style");b.type="text/css";if(b.styleSheet)b.styleSheet.cssText=a;else{var c=document.createTextNode(a);b.appendChild(c)}var d=document.getElementsByTagName("head")[0];d.appendChild(b)}},queue:{},recipes:{},filters:{off:function(){return this.text}}}),$.fn.chili=function(a){var b=$.extend({},$.chili);return $.chili=$.extend(!0,$.chili,a||{}),this.each(function(){askDish(this)}),$.chili=b,this}})(jQuery);